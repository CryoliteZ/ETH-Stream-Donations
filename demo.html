<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.light_blue-amber.min.css" />
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="ABI.js"></script>
    <style>
        body {
            background-color: #333;
        }

        .donation-box {
            margin: auto;
        }

        .donation-box .donation-header {
            font-size: 1.2em;
            margin: 2% 0;
            color: #FFFFFF;
            font-family: "Comic Sans MS", "Comic Sans", cursive;
        }

        .donation-card {
            width: 100%;
        }

        .hide{
            display: none;
        }
    </style>


</head>

<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer">
        <div class="donation-box">
            <div class="donation-header"> Waiting for donations..</div>
            <div id="p2" class="mdl-progress mdl-js-progress mdl-progress__indeterminate progress-bar"></div>
            <div class="mdl-card mdl-shadow--2dp donation-card hide">
                <div class="mdl-card__title">
                    <h2 class="mdl-card__title-text donation-donor_name">name</h2>
                </div>
                <div class="mdl-card__supporting-text ">
                    <div class="">
                        Donor address:
                        <span class="donation-donor_addr"></span>
                    </div>
                    <div class="">
                        Reciever address:
                        <span class="donation-recv_addr"></span>
                    </div>
                    <div class="">
                        Donate message:
                        <span class="donation-donate_mssg"></span>
                    </div>
                </div>
                <div class="mdl-card__menu">
                    <span class="donation-donate_value">123</span> ETH
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    $(document).ready(function () {
        function formatBigNumber(num) {
            function formatNumber(val) {
                let val_length = val.toString().length;
                return val / (10 ** (val_length - 1));
            }
            let bn;
            if (num['c'].length == 1) {
                bn = formatNumber(num['c'][0]) * (10 ** (num['e'] - 18));
            } else {
                bn = (formatNumber(num['c'][0].toString() + num['c'][1].toString()) * (10 ** (num['e'] - 18)));
            }
            return bn.toFixed(7);
        }
        const DonateContractABI = web3.eth.contract(CONTRACT_ABI);
        const DonateContract = DonateContractABI.at("0x45d8a9f9d2495250041d9715ad54289473c458d6");
        let donateEvent = DonateContract.NewDonation();
        donateEvent.watch(function (error, result) {
            console.log(result);
            let donor_addr = result.args.daddr;
            let donor_name = result.args.donor;
            let recv_addr = result.args.raddr;
            let donate_mssg = result.args.message;
            let donate_value = formatBigNumber(result.args.value);
            console.log(donate_value);
            $('.donation-header').text("Got a donation!");
            $('.donation-donor_name').text(donor_name);
            $('.donation-donor_addr').text(donor_addr);
            $('.donation-recv_addr').text(recv_addr);
            $('.donation-donate_mssg').text(donate_mssg);
            $('.donation-donate_value').text(donate_value);
            $('.donation-card').removeClass('hide');
            $('.progress-bar').addClass('hide');
            setTimeout(function(){
                $('.donation-card').addClass('hide');
                $('.progress-bar').removeClass('hide');
                $('.donation-header').text("Waiting for donations..");
            }, 10000);
        })

    })
</script>